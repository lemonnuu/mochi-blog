import{_ as s,c as n,o as a,a as l}from"./app.b2e948b4.js";const F=JSON.parse('{"title":"vue-next 源码解析前的准备工作","titleTemplate":false,"description":"","frontmatter":{"date":"2023-01-08 19:06:44","title":"vue-next 源码解析前的准备工作","titleTemplate":false,"author":"Mochi","outline":[2,4],"categories":["note"],"tags":["vue"]},"headers":[{"level":2,"title":"vue-next 目录结构","slug":"vue-next-目录结构","link":"#vue-next-目录结构","children":[]},{"level":2,"title":"添加测试实例","slug":"添加测试实例","link":"#添加测试实例","children":[{"level":3,"title":"初步添加","slug":"初步添加","link":"#初步添加","children":[]},{"level":3,"title":"source map 调试","slug":"source-map-调试","link":"#source-map-调试","children":[]}]},{"level":2,"title":"阅读源码的正确姿势","slug":"阅读源码的正确姿势","link":"#阅读源码的正确姿势","children":[]}],"relativePath":"_NOTES/vue/001_directory-structure.md","lastUpdated":1673231417000}'),p={name:"_NOTES/vue/001_directory-structure.md"},e=l(`<h1 id="vue-next-源码解析前的准备工作" tabindex="-1">vue-next 源码解析前的准备工作 <a class="header-anchor" href="#vue-next-源码解析前的准备工作" aria-hidden="true">#</a></h1><blockquote><p>解析的 Vue 版本为 3.2.37 (下载地址：<a href="https://github.com/lemonnuu/vue-next-3.2.37" target="_blank" rel="noreferrer">vue-next-3.2.37</a>)</p></blockquote><h2 id="vue-next-目录结构" tabindex="-1">vue-next 目录结构 <a class="header-anchor" href="#vue-next-目录结构" aria-hidden="true">#</a></h2><div class="language-text"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">vue-next-3.2.37/</span></span>
<span class="line"><span style="color:#A6ACCD;">├── packages/ ⭕ 核心代码区</span></span>
<span class="line"><span style="color:#A6ACCD;">│   ├── compiler-core/ ⭕ 编译器的核心代码</span></span>
<span class="line"><span style="color:#A6ACCD;">│   ├── compiler-dom/ ⭕ 浏览器相关的编译模块</span></span>
<span class="line"><span style="color:#A6ACCD;">│   ├── compiler-sfc/ 👉 单文件组件(.vue)的编译模块</span></span>
<span class="line"><span style="color:#A6ACCD;">│   ├── compiler-ssr/ 👉 服务端渲染的编译模块</span></span>
<span class="line"><span style="color:#A6ACCD;">│   ├── global.d.ts 👉 全局的 TS 声明</span></span>
<span class="line"><span style="color:#A6ACCD;">│   ├── reactivity/ 👉 响应性的核心模块</span></span>
<span class="line"><span style="color:#A6ACCD;">│   ├── reactivity-transform/ 👉 已过期, 无需关注</span></span>
<span class="line"><span style="color:#A6ACCD;">│   ├── runtime-core/ ⭕ 运行时的核心代码, 内部针对不同平台进行了实现</span></span>
<span class="line"><span style="color:#A6ACCD;">│   ├── runtime-dom/ ⭕ 基于浏览器平台的运行时</span></span>
<span class="line"><span style="color:#A6ACCD;">│   ├── runtime-test/ 👉 runtime 测试相关</span></span>
<span class="line"><span style="color:#A6ACCD;">│   ├── server-renderer/ 👉 服务器渲染</span></span>
<span class="line"><span style="color:#A6ACCD;">│   ├── sfc-playground/ 👉 sfc 工具, 如 https://sfc.vuejs.org/</span></span>
<span class="line"><span style="color:#A6ACCD;">│   ├── shared/ ⭕ 共享的工具类</span></span>
<span class="line"><span style="color:#A6ACCD;">│   ├── size-check/ 👉 测试运行时包的大小</span></span>
<span class="line"><span style="color:#A6ACCD;">│   ├── template-explorer/ 👉 提供了一个线上的测试</span></span>
<span class="line"><span style="color:#A6ACCD;">│   ├──   (https://template-explorer.vuejs.org), 用于将 template 转化为 render</span></span>
<span class="line"><span style="color:#A6ACCD;">│   ├── vue/ ⭕ 测试实例、打包后的 dist 文件夹都在这里</span></span>
<span class="line"><span style="color:#A6ACCD;">│   └── vue-compat/ 👉 用于兼容 Vue2 代码</span></span>
<span class="line"><span style="color:#A6ACCD;">├── pnpm-lock.yaml 👉 pnpm 依赖包版本</span></span>
<span class="line"><span style="color:#A6ACCD;">├── pnpm-workspace.yaml 👉 pnpm 配置文件</span></span>
<span class="line"><span style="color:#A6ACCD;">├── rollup.config.mjs 👉 rollup 配置文件</span></span>
<span class="line"><span style="color:#A6ACCD;">├── scripts/ 👉 配置文件相关, 不需要关注</span></span>
<span class="line"><span style="color:#A6ACCD;">├── test-dts/ 👉 测试相关, 不需要关注</span></span>
<span class="line"><span style="color:#A6ACCD;">├── BACKERS.md 👉 赞助声明</span></span>
<span class="line"><span style="color:#A6ACCD;">├── CHANGELOG.md 👉 更新日志</span></span>
<span class="line"><span style="color:#A6ACCD;">├── LICENSE 👉 开源协议</span></span>
<span class="line"><span style="color:#A6ACCD;">├── README.md 👉 readme</span></span>
<span class="line"><span style="color:#A6ACCD;">├── SECURITY.md 👉 报告漏洞, 维护安全的声明文件</span></span>
<span class="line"><span style="color:#A6ACCD;">├── api-extractor.json 👉 TypeScript 的 API 分析工具</span></span>
<span class="line"><span style="color:#A6ACCD;">├── jest.config.js 👉 测试相关</span></span>
<span class="line"><span style="color:#A6ACCD;">├── netlify.toml 👉 自动化部署相关</span></span>
<span class="line"><span style="color:#A6ACCD;">├── package.json 👉 npm 依赖</span></span>
<span class="line"><span style="color:#A6ACCD;">└── tsconfig.json 👉 Typescript 配置文件</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h2 id="添加测试实例" tabindex="-1">添加测试实例 <a class="header-anchor" href="#添加测试实例" aria-hidden="true">#</a></h2><p>在添加测试实例之前, 首先得对项目安装依赖并进行打包, 依次执行：</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">pnpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span></span>
<span class="line"><span style="color:#FFCB6B;">pnpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">build</span></span>
<span class="line"></span></code></pre></div><p>当打包成功时, 在 <code>vue-next-3.2.37/packages/vue/</code> 文件夹下会新增出 dist 文件夹：</p><div class="language-text"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">vue/dist/</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.cjs.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.cjs.prod.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.esm-browser.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.esm-browser.prod.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.esm-bundler.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.global.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.global.prod.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.runtime.esm-browser.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.runtime.esm-browser.prod.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.runtime.esm-bundler.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.runtime.global.js</span></span>
<span class="line"><span style="color:#A6ACCD;">└── vue.runtime.global.prod.js</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><blockquote><p>注: 在打包 vue-next 时, 默认是不开启 sourmap 的。</p></blockquote><h3 id="初步添加" tabindex="-1">初步添加 <a class="header-anchor" href="#初步添加" aria-hidden="true">#</a></h3><p>在 <code>vue-next-3.2.37/packages/vue/examples/</code> 下新建 mochi 文件夹用于存放测试实例：</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">examples/</span></span>
<span class="line"><span style="color:#A6ACCD;">└── mochi/</span></span>
<span class="line"><span style="color:#A6ACCD;">    └── reactivity/</span></span>
<span class="line"><span style="color:#A6ACCD;">        └── reactive.html</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>可以先简单验证一下打包生成的文件是否有效：</p><div class="vp-code-group"><div class="tabs"><input type="radio" name="group--Z6Tn" id="tab-7V2-rjx" checked="checked"><label for="tab-7V2-rjx">reactive.html</label></div><div class="blocks"><div class="language-html active"><button title="Copy Code" class="copy"></button><span class="lang">html</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;">&lt;!</span><span style="color:#F07178;">DOCTYPE</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">html</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">html</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">lang</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">en</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">head</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">meta</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">charset</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">UTF-8</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">meta</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">http-equiv</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">X-UA-Compatible</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">content</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">IE=edge</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">meta</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">name</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">viewport</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">content</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">width=device-width, initial-scale=1.0</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">title</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">Document</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">title</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">    &lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">src</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">../../../dist/vue.global.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">head</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">id</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">app</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;&lt;/</span><span style="color:#F07178;">div</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">    &lt;</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> reactive</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> effect </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Vue</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> user </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">reactive</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">name</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">张三</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#82AAFF;">effect</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> (document</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getElementById</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">app</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">innerHTML </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> user</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">name))</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#82AAFF;">setTimeout</span><span style="color:#A6ACCD;">(</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#A6ACCD;"> (user</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">name </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">李四</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;">)</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2000</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">script</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">body</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">html</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div></div></div><p>Live Server 打开 reactive.html, 如果出现&quot;张三&quot;且两秒后变为&quot;李四&quot;则一切 OK。</p><h3 id="source-map-调试" tabindex="-1">source map 调试 <a class="header-anchor" href="#source-map-调试" aria-hidden="true">#</a></h3><p>想要开启 sourcemap 功能也非常简单, 只需在 build 命令后添加 <code>-sourcemap</code> 或 <code>-s</code> 参数即可。</p><div class="vp-code-group"><div class="tabs"><input type="radio" name="group-7pfqr" id="tab-z_Gkzqu" checked="checked"><label for="tab-z_Gkzqu">package.json</label></div><div class="blocks"><div class="language-json active"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-palenight has-diff"><code><span class="line"><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">scripts</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">: </span><span style="color:#89DDFF;">{</span></span>
<span class="line diff remove"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">build</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">node scripts/build.js</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span></span>
<span class="line diff add"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">build</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">node scripts/build.js -s</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"></span></code></pre></div></div></div><blockquote><p>翻看 <code>vue-next-3.2.37/scripts/build.js</code> 会发现先是使用了 <a href="https://www.npmjs.com/package/minimist" target="_blank" rel="noreferrer">minimist</a> 进行命令行参数解析, 然后会交给 rollup.config.js 开启相应功能。</p></blockquote><p>再次打包后, dist 文件夹下将会包含 .map 文件:</p><div class="language-text"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">dist/</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.cjs.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.cjs.js.map</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.cjs.prod.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.cjs.prod.js.map</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.esm-browser.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.esm-browser.js.map</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.esm-browser.prod.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.esm-browser.prod.js.map</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.esm-bundler.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.esm-bundler.js.map</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.global.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.global.js.map</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.global.prod.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.global.prod.js.map</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.runtime.esm-browser.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.runtime.esm-browser.js.map</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.runtime.esm-browser.prod.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.runtime.esm-browser.prod.js.map</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.runtime.esm-bundler.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.runtime.esm-bundler.js.map</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.runtime.global.js</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.runtime.global.js.map</span></span>
<span class="line"><span style="color:#A6ACCD;">├── vue.runtime.global.prod.js</span></span>
<span class="line"><span style="color:#A6ACCD;">└── vue.runtime.global.prod.js.map</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h2 id="阅读源码的正确姿势" tabindex="-1">阅读源码的正确姿势 <a class="header-anchor" href="#阅读源码的正确姿势" aria-hidden="true">#</a></h2><p>阅读源码千万不要一行一行逐条逐句的去读, 可行的方式是跟随一条主线 debugger。</p><ul><li>摒弃边缘情况</li><li>跟随一条主线</li></ul><p>也就是说, 仅需要跟随一条主线阅读核心逻辑。</p>`,26),o=[e];function t(c,r,D,i,y,C){return a(),n("div",null,o)}const u=s(p,[["render",t]]);export{F as __pageData,u as default};
